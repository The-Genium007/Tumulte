# =============================================================================
# Prometheus Configuration - Tumulte
# =============================================================================
# Ce fichier configure les cibles (targets) que Prometheus va scraper
# pour collecter les métriques.
#
# Les targets backend/frontend sont configurés via les variables d'environnement:
#   - BACKEND_TARGET (ex: host.docker.internal:3333, tumulte-backend-staging:3333)
#   - FRONTEND_TARGET (ex: host.docker.internal:3000, tumulte-frontend-staging:3000)
#
# Usage par environnement:
#   - Dev: host.docker.internal:PORT (accès au host depuis Docker)
#   - Staging: tumulte-backend-staging:3333, tumulte-frontend-staging:3000
#   - Prod: tumulte-backend-prod:3333, tumulte-frontend-prod:3000
#
# =============================================================================

global:
  # Intervalle de scrape par défaut (toutes les 15 secondes)
  scrape_interval: 15s
  # Intervalle d'évaluation des règles d'alerte
  evaluation_interval: 15s
  # Labels ajoutés à toutes les métriques
  # Note: ENVIRONMENT est défini via docker-compose (development/staging/production)
  external_labels:
    project: 'tumulte'

# Règles d'alertes
rule_files:
  - 'alerts.yml'

# Configuration Alertmanager (si tu l'utilises)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# =============================================================================
# SCRAPE CONFIGS - Les sources de métriques
# =============================================================================
scrape_configs:
  # ---------------------------------------------------------------------------
  # Prometheus lui-même (pour monitorer Prometheus)
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # ---------------------------------------------------------------------------
  # TUMULTE BACKEND - Métriques applicatives AdonisJS
  # ---------------------------------------------------------------------------
  # Ton backend expose /metrics avec prom-client
  #
  # Configuration des targets par environnement (dans .env):
  #   Dev:     BACKEND_TARGET=host.docker.internal:3333
  #   Staging: BACKEND_TARGET=tumulte-backend-staging:3333
  #   Prod:    BACKEND_TARGET=tumulte-backend-prod:3333
  #
  # Note: En staging/prod avec Docker, les containers sont sur le même réseau
  # Docker (dokploy-network + monitoring), donc on utilise le hostname du container.
  #
  - job_name: 'tumulte-backend'
    metrics_path: '/metrics'
    static_configs:
      # Dev: utilise host.docker.internal pour accéder au host
      # Staging/Prod: configurer via file_sd_configs ou modifier ce fichier
      - targets: ['host.docker.internal:3333']
        labels:
          service: 'backend'
          app: 'tumulte'
    # Timeout plus long pour le backend (peut être lent au démarrage)
    scrape_timeout: 10s
    # Si ton endpoint /metrics nécessite une auth, décommente :
    # basic_auth:
    #   username: 'prometheus'
    #   password_file: '/etc/prometheus/backend_auth'

  # ---------------------------------------------------------------------------
  # TUMULTE FRONTEND - Métriques Nuxt SSR
  # ---------------------------------------------------------------------------
  # Configuration des targets par environnement (dans .env):
  #   Dev:     FRONTEND_TARGET=host.docker.internal:3000
  #   Staging: FRONTEND_TARGET=tumulte-frontend-staging:3000
  #   Prod:    FRONTEND_TARGET=tumulte-frontend-prod:3000
  #
  - job_name: 'tumulte-frontend'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['host.docker.internal:3000']
        labels:
          service: 'frontend'
          app: 'tumulte'
    scrape_timeout: 10s

  # ---------------------------------------------------------------------------
  # NODE EXPORTER - Métriques système (CPU, RAM, disque, réseau)
  # ---------------------------------------------------------------------------
  # Lance node_exporter sur ta machine hôte ou dans un container
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          service: 'node'

  # ---------------------------------------------------------------------------
  # CADVISOR - Métriques Docker (containers)
  # ---------------------------------------------------------------------------
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
        labels:
          service: 'docker'

  # ---------------------------------------------------------------------------
  # POSTGRES EXPORTER - Métriques PostgreSQL
  # ---------------------------------------------------------------------------
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          service: 'postgresql'
          database: 'twitch_polls'

  # ---------------------------------------------------------------------------
  # REDIS EXPORTER - Métriques Redis
  # ---------------------------------------------------------------------------
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: 'redis'

# =============================================================================
# Cloudflare Tunnel - Secure Access to Monitoring Stack
# =============================================================================
#
# Ce fichier ajoute un tunnel Cloudflare pour exposer Grafana de manière sécurisée
# sans ouvrir de ports sur le serveur.
#
# Prérequis:
# 1. Créer un tunnel dans le dashboard Cloudflare Zero Trust
#    https://one.dash.cloudflare.com/ > Access > Tunnels > Create Tunnel
# 2. Copier le token du tunnel dans CLOUDFLARE_TUNNEL_TOKEN
# 3. Configurer les routes dans le dashboard:
#    - monitoring.tumulte.app -> http://grafana:3000
#    - (optionnel) prometheus.tumulte.app -> http://prometheus:9090
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.staging.yml \
#     -f cloudflare/docker-compose.tunnel.yml --env-file .env.staging up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # CLOUDFLARE TUNNEL - Zero Trust Access
  # ---------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: tumulte-cloudflared-${ENV_SUFFIX:-prod}
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - monitoring
    labels:
      - "tumulte.environment=${ENVIRONMENT:-production}"
      - "tumulte.component=cloudflare-tunnel"
    # Health check - vérifie que le tunnel est connecté
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    # Dépend de Grafana pour s'assurer qu'il est up
    depends_on:
      grafana:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # GRAFANA - Override pour fonctionner avec le tunnel
  # ---------------------------------------------------------------------------
  grafana:
    # Pas d'exposition de port en mode tunnel (sécurité)
    # Le port 3001 n'est plus accessible directement
    ports: !override []
    environment:
      # URL publique via le tunnel
      - GF_SERVER_ROOT_URL=https://${GRAFANA_PUBLIC_DOMAIN:-monitoring.tumulte.app}
      - GF_SERVER_DOMAIN=${GRAFANA_PUBLIC_DOMAIN:-monitoring.tumulte.app}
      # Sécurité renforcée pour l'accès public
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=strict
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY_MAX_AGE_SECONDS=31536000
      - GF_SECURITY_X_CONTENT_TYPE_OPTIONS=true
      - GF_SECURITY_X_XSS_PROTECTION=true
      # Désactiver l'embedding (sécurité)
      - GF_SECURITY_ALLOW_EMBEDDING=false
    labels:
      - "cloudflare.tunnel.hostname=${GRAFANA_PUBLIC_DOMAIN:-monitoring.tumulte.app}"
      - "cloudflare.tunnel.service=http://grafana:3000"
    # Health check pour le tunnel
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # PROMETHEUS - Ne pas exposer publiquement par défaut
  # ---------------------------------------------------------------------------
  prometheus:
    # Supprimer l'exposition publique du port
    ports: !override []
    labels:
      - "tumulte.tunnel.exposed=false"

  # ---------------------------------------------------------------------------
  # ALERTMANAGER - Ne pas exposer publiquement
  # ---------------------------------------------------------------------------
  alertmanager:
    ports: !override []
    labels:
      - "tumulte.tunnel.exposed=false"

# =============================================================================
# CONFIGURATION CLOUDFLARE ZERO TRUST (à faire dans le dashboard)
# =============================================================================
#
# 1. Créer le tunnel:
#    - Nom: tumulte-monitoring-{staging|prod}
#    - Connector: Docker
#
# 2. Configurer les routes publiques:
#    ┌─────────────────────────────────┬────────────────────────────┐
#    │ Public hostname                 │ Service                    │
#    ├─────────────────────────────────┼────────────────────────────┤
#    │ monitoring.tumulte.app          │ http://grafana:3000        │
#    │ monitoring-staging.tumulte.app  │ http://grafana:3000        │
#    └─────────────────────────────────┴────────────────────────────┘
#
# 3. (Optionnel) Ajouter une Access Policy pour authentification:
#    - Access > Applications > Add Application
#    - Type: Self-hosted
#    - Domain: monitoring.tumulte.app
#    - Policy: Allow - Emails ending in @tumulte.app
#              ou Allow - One-time PIN
#
# =============================================================================
